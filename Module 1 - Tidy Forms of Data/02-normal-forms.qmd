---
title: 'Normal Forms of data'
date: '2025-08-28'
engine: knitr
type: slides
execute:
  error: true
  eval: true
  echo: false
format:
  revealjs:
    navigation-mode: vertical
    logo: ../../N.svg
    includes:
      in_header: ../../header.html
categories:
- Week02
--- 

```{r message=FALSE, warning=FALSE}
library(tidyverse)
```

# Double entry or error?

The data set below is tidy, but does not allow us to distinguish between two Alices in the class or a data entry

```{r}
students <- data.frame(
  student_name = c("Alice", "Alice", "Bob", "Bob", "Alice", "Alice"),
  course = c("Math", "Science", "Math", "Science", "Math", "Science"),
  grade = c(85, 92, 78, 88, 82, 90)
)

students
```

- solution(?) - add a last name!
```{r echo = TRUE}
students$last_name <- rep(c("A", "B", "B"), each = 2)
```

# IDs over names

Identifiers help us to 

- distinguish between individuals with the same name, 
- track individuals across name changes

```{r echo = TRUE}
students$student_id <- rep(1:3, each = 2)
```


# First normal form 

**The key**

A tidy data set is in first normal form, if it has a **key**.

<br>


The *key of a data set* is defined as the (set of) variable(s) that uniquely identifies each row

A key should be *stable* and *unique* over time.



# What is the key?

```{r}
students
```

# Is there a key?

```{r}
students |> select(-student_id)
```

# Key variables

- Identifying the key needs some practice

- Maybe helpful: think about the problem as statistical design question (what is designed ahead of a study, what is observed)

- all design variables are part of the key

- no measurement variable should be part of the key


# Identifying the key


## Biological experiment

In a study, RNA-seq expressions of 11k different genes are measured at 6 and 12 hours after seeds from two different gene lines have germinated.


What is the key?


## Weather station

A weather station publishes monthly averages for the minimum and maximum temperature during each hour of the day.

What is the key?

## Tuberculosis

The World Health Organization track the number of new incidences of tuberculosis by sex and age group in each country. 

What is the key?

## French Fries

In a 10 week sensory experiment, 12 individuals assess taste of french fries on several scales (how potato-y, buttery, grassy, rancid, paint-y do they taste?), fried in one of 3 different oils, replicated twice. 

What is the key?



# Data queries

- Generally, data doesn't just exist but should provide answers to questions 

- What questions can you think of? 

```{r}
students
```

# Sample Questions

- What grade does student X have in subject Y?

- What is the average grade in subject Y?

- How many courses does student X take? 

- How many students have taken subject Y?

- How many students are enrolled in total? 

# Your Turn {background-color="#006666"}

Write code to create data summaries to answer: 

- What is the average grade in each subject?

- How many courses does each student take? 

- How many students are enrolled in total? 


# Updates to the data

- What happens, if Bob withdraws from Math and Science?

```{r}
students
```

::: {.fragment .fade-in}
- It looks like Bob has left the school!
- **deletion anomaly**
:::


# Issues with 1st normal form data

Potential consistency issues ("split key problems"):

- **Update anomaly**: e.g. change to person's name  must be made in multiple rows
- **Insert anomaly**: e.g. student can't be registered without being enrolled in at least one class
- **Delete anomaly**: e.g. student can't withdraw from classes without being removed completely


Efficiency problem:

- **Storage waste**:  `student_name` and `last_name` repeated unnecessarily

# Second Normalform

**the whole key**

A data set is in second normal form if

- it is in 1st NF
- and no non-key variable depends on only a part of the key

::: {.fragment .fade-in}

All data in 1st NF with a single variable as a key are automatically in 2nd NF!
:::



# Normalizing from 1st to 2nd

::: {.fragment .fade-in}

Idea: If the key is split, split the dataset into two
:::

::::: {.fragment .fade-in}

:::: {.columns}

::: {.column width="40%"}

```{r echo=TRUE}
students_registered <- students |> 
  group_by(student_id) |>
  summarize(first = student_name[1], 
            second = last_name[1])

students_registered
```
:::

::: {.column width="10%"}
<!-- empty column to create gap -->
:::

::: {.column width="40%"}

```{r echo=TRUE}
students_enrolled <- students |>
  select(student_id, course, grade) 

students_enrolled
```

:::

::::

:::::
# Adding letter grades

Assume that the registrar adds letter grades to the dataset `students_enrolled`:

```{r echo=TRUE}
students_enrolled$letter_grades <- c("B", "A-", "C+", "B+", "B-", "A-")
```

Why could this be a potential problem?

# Issues with the second Normal form

Potential consistency issue: 

- **transitive dependencies**: e.g. change to points might require a change to the letter grade.


# Third Normalform

**and nothing but the key**

A data set is in third normal form if

1. it is in second normal form, and
2. no non-key variable determines the values of another non-key variable (no transitive dependency)

# Normalizing from 2nd to 3rd

If there is a transitive dependency, 

- remove the dependent variable from the dataset

- create a new table to capture the dependency 

```{r echo = TRUE}
grading_scheme <- data.frame(
    letter_grade = c("F", "D-", "D", "D+", "C-", "C", "C+", 
            "B-", "B", "B+", "A-", "A", "A+"),
    point_minimum = c(0, 60, 63, 67, 70, 73, 77, 80, 83, 87, 90, 93, 97)
)
```

- (optional) encode the dependency as function
```{r echo=TRUE}
point_to_letter <- function(point) {
  idx <- max(which(point >= grading_scheme$point_minimum))
  
  grading_scheme$letter_grade[idx]
}
```

```{r}
point_to_letter(30)
point_to_letter(99)
```




# Additional Resources

Another example data set: [chapter 25:  Normal Forms of Data
](https://srvanderplas.github.io/stat-computing-r-python/part-wrangling/05b-normal-forms.html)

Watch Decomplexify's video on Normal forms: https://www.youtube.com/watch?v=GFQaEYEc8_8
